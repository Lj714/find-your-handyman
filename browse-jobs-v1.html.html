<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Browse Jobs | Find Your Next Handyman</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styles.css" />
  <style>
    .controls{display:flex;gap:.75rem;flex-wrap:wrap;margin:1rem 0 1.25rem}
    .controls input,.controls select{padding:.55rem .75rem;border:1px solid #cbd5e1;border-radius:10px;font-size:.95rem;min-width:220px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:1rem}
    .card{background:#fff;border:1px solid #e2e8f0;border-radius:16px;padding:1rem;box-shadow:0 10px 30px rgba(15,23,42,.06)}
    .card h3{margin:0 0 .4rem;font-size:1.05rem}
    .meta{color:#475569;font-size:.9rem;margin:.15rem 0}
    .pill{display:inline-block;background:#eef2ff;color:#1d4ed8;padding:.18rem .55rem;border-radius:999px;font-size:.8rem;font-weight:600}
	    .actions{display:flex;gap:.6rem;flex-wrap:wrap;margin-top:.8rem}
	    .btn{display:inline-flex;align-items:center;justify-content:center;padding:.55rem 1rem;border-radius:999px;border:1px solid #cbd5e1;background:#fff;color:#0f172a;font-weight:600;cursor:pointer}
	    .btn-primary{background:#2563eb;border-color:#2563eb;color:#fff}
	    .btn:disabled{opacity:.6;cursor:not-allowed}
	    .modal-overlay{position:fixed;inset:0;background:rgba(15,23,42,.55);display:none;align-items:center;justify-content:center;padding:1rem;z-index:9999}
	    .modal{width:min(560px,100%);background:#fff;border-radius:18px;box-shadow:0 20px 60px rgba(15,23,42,.35);overflow:hidden}
	    .modal header{padding:1rem 1.25rem;border-bottom:1px solid #e2e8f0;display:flex;align-items:center;justify-content:space-between}
	    .modal header h3{margin:0;font-size:1.05rem}
	    .modal .body{padding:1rem 1.25rem}
	    .modal label{display:block;font-weight:600;margin:.75rem 0 .35rem}
	    .modal input,.modal textarea{width:100%;padding:.6rem .75rem;border:1px solid #cbd5e1;border-radius:10px;font-size:.95rem;box-sizing:border-box}
	    .modal textarea{min-height:110px;resize:vertical}
	    .modal .footer{padding:1rem 1.25rem;border-top:1px solid #e2e8f0;display:flex;gap:.6rem;justify-content:flex-end}
	    .status{margin-top:.75rem;font-size:.9rem}
	    .status.ok{color:#15803d}
	    .status.err{color:#b91c1c}
    .empty{padding:1rem;background:#fff;border:1px dashed #cbd5e1;border-radius:16px;color:#475569}
    .error{padding:1rem;background:#fff1f2;border:1px solid #fecdd3;border-radius:16px;color:#9f1239}
  </style>
</head>

<body>
  <header>
    <div class="container nav-bar">
      <div class="logo">Find Your Next Handyman</div>
      <nav>
        <a href="index.html">Home</a>
        <a href="get-started.html">Get Started</a>
        <a href="browse-handymen.html">Browse Handymen</a>
        <a href="browse-jobs.html" class="active">Browse Jobs</a>
      </nav>
    </div>
  </header>

  <main>
    <section class="section">
      <div class="container">
        <h2>Available jobs</h2>
        <p class="note" style="margin-bottom: 1rem;">These jobs are pulled from your Airtable base, but shown in your website UI.</p>

        <div class="controls">
          <input id="q" type="search" placeholder="Search title, location, or details‚Ä¶" />
          <select id="service">
            <option value="">All services</option>
          </select>
          <select id="sort">
            <option value="newest">Newest first</option>
            <option value="oldest">Oldest first</option>
          </select>
        </div>

        <div id="status"></div>
        <div id="grid" class="grid" aria-live="polite"></div>
      </div>
    </section>
  </main>

  <div class="modal-backdrop" id="contactJobBackdrop" aria-hidden="true">
    <div class="modal" id="contactJobModal" role="dialog" aria-modal="true" aria-labelledby="contactJobTitle">
      <button class="modal-x" type="button" id="contactJobClose" aria-label="Close">√ó</button>
      <h2 id="contactJobTitle" style="margin:0 0 .25rem">Contact customer</h2>
      <p style="margin:.25rem 0 1rem;color:#475569">Send an enquiry. Your message will be delivered to the customer.</p>

      <form id="contactForm">
        <div class="field">
          <label for="fromName">Your name</label>
          <input id="fromName" name="fromName" type="text" required />
        </div>
        <div class="field">
          <label for="fromEmail">Your email</label>
          <input id="fromEmail" name="fromEmail" type="email" required />
        </div>
        <div class="field">
          <label for="fromPhone">Your phone</label>
          <input id="fromPhone" name="fromPhone" type="tel" />
        </div>
        <div class="field">
          <label for="message">Message</label>
          <textarea id="message" name="message" required placeholder="Hi, I'm interested in this job..."></textarea>
        </div>

        <input type="hidden" id="relatedJobId" name="relatedJobId" />

        <div class="actions" style="margin-top:0">
          <button class="btn btn-primary" id="contactSubmit" type="submit">Send enquiry</button>
          <button class="btn" type="button" id="contactCancel">Cancel</button>
        </div>
        <div id="contactStatus" class="status" aria-live="polite"></div>
      </form>
    </div>
  </div>

  <footer>
    <div class="container">
      <p>&copy; <span id="year"></span> Find Your Next Handyman. All rights reserved.</p>
    </div>
  </footer>

  <script>
    document.getElementById('year').textContent = new Date().getFullYear();

    const API_BASE = "https://handyman-public-api-v4.l-aigbefoh.workers.dev";
	    const ENQUIRIES_WORKER_URL = "https://handyman-enquiries-webhook.l-aigbefoh.workers.dev/";

    const elQ = document.getElementById('q');
    const elService = document.getElementById('service');
    const elSort = document.getElementById('sort');
    const elGrid = document.getElementById('grid');
    const elStatus = document.getElementById('status');

    let allJobs = [];

    function escapeHtml(s){
      return String(s ?? '').replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;','\'':'&#39;'}[c]));
    }

	    function normalizeJobs(data){
	      const rows = Array.isArray(data) ? data : (data.jobs || data.items || data.records || []);
	      if (!Array.isArray(rows)) return [];
	      return rows.map((r) => {
	        if (r && r.fields) {
	          const f = r.fields;
	          return {
	            id: r.id,
	            jobTitle: f['Job Title'] || f.JobTitle || f.jobTitle,
	            location: f.Location || f.location,
	            jobDetails: f['Job Details'] || f.jobDetails,
	            preferredTiming: f['Preferred Timing'] || f.preferredTiming,
	            mainServiceNeeded: f['Main Service Needed'] || f.mainServiceNeeded,
	            createdTime: r.createdTime
	          };
	        }
	        return r;
	      });
	    }

    function setStatus(type, msg){
      elStatus.className = type;
      elStatus.textContent = msg;
    }

    function toServiceLabel(job){
      return job.mainServiceNeeded || job.mainService || job.service || '';
    }

    function render(){
      const q = elQ.value.trim().toLowerCase();
      const svc = elService.value;
      const sort = elSort.value;

      let filtered = allJobs.filter(j => {
        const hay = [j.jobTitle, j.location, j.jobDetails, j.preferredTiming, toServiceLabel(j)].join(' ').toLowerCase();
        const matchesQ = !q || hay.includes(q);
        const matchesSvc = !svc || toServiceLabel(j) === svc;
        return matchesQ && matchesSvc;
      });

      filtered.sort((a,b) => {
        const da = new Date(a.createdTime || a.created || a._createdTime || 0).getTime();
        const db = new Date(b.createdTime || b.created || b._createdTime || 0).getTime();
        return sort === 'oldest' ? (da - db) : (db - da);
      });

      if (filtered.length === 0){
        elGrid.innerHTML = '';
        setStatus('empty', 'No jobs match your filters yet.');
        elStatus.className = 'empty';
        return;
      }

      elStatus.className = '';
      elStatus.textContent = '';

	      elGrid.innerHTML = filtered.map(j => {
        const title = escapeHtml(j.jobTitle || 'Job');
        const location = escapeHtml(j.location || '');
        const details = escapeHtml(j.jobDetails || '');
        const timing = escapeHtml(j.preferredTiming || '');
	        const service = escapeHtml(toServiceLabel(j) || '');
	        const recId = escapeHtml(j.id || j.recordId || j.recId || '');
        return `
          <article class="card">
            <h3>${title}</h3>
            ${service ? `<div class="meta"><span class="pill">${service}</span></div>` : ''}
            ${location ? `<div class="meta">üìç ${location}</div>` : ''}
            ${timing ? `<div class="meta">üóìÔ∏è ${timing}</div>` : ''}
	            ${details ? `<div class="meta" style="margin-top:.5rem">${details}</div>` : ''}
	            <div class="actions">
	              <button class="btn btn-primary" data-action="contact-job" data-job-id="${recId}" data-job-title="${title}">Contact customer</button>
	            </div>
          </article>
        `;
      }).join('');
    }

    async function load(){
      try{
        setStatus('empty', 'Loading jobs‚Ä¶');
        elStatus.className = 'empty';

        const res = await fetch(`${API_BASE}/jobs`, { method: 'GET' });
        if (!res.ok) throw new Error(`API failed (${res.status})`);

	        const data = await res.json();
	        allJobs = normalizeJobs(data);

        const services = Array.from(new Set(allJobs.map(toServiceLabel).filter(Boolean))).sort();
        for (const s of services){
          const opt = document.createElement('option');
          opt.value = s;
          opt.textContent = s;
          elService.appendChild(opt);
        }

        render();
      }catch(err){
        console.error(err);
        elGrid.innerHTML = '';
        elStatus.className = 'error';
        elStatus.textContent = 'Could not load jobs. Check your API worker URL and that it returns JSON.';
      }
    }

	    elQ.addEventListener('input', render);
    elService.addEventListener('change', render);
    elSort.addEventListener('change', render);

	    const modal = document.getElementById('contactJobModal');
	    const modalTitle = document.getElementById('contactJobModalTitle');
	    const modalStatus = document.getElementById('contactJobStatus');
	    const modalForm = document.getElementById('contactJobForm');
	    const modalClose = document.getElementById('contactJobClose');
	    const modalBackdrop = document.getElementById('contactJobBackdrop');
	    const modalJobId = document.getElementById('contactJobId');
	    const modalSubmit = document.getElementById('contactJobSubmit');

	    function openModal({ jobId, jobTitle }){
	      modalJobId.value = jobId;
	      modalTitle.textContent = `Contact customer about: ${jobTitle || 'Job'}`;
	      modalStatus.textContent = '';
	      modalStatus.className = '';
	      modalForm.reset();
	      modal.classList.add('open');
	    }
	    function closeModal(){ modal.classList.remove('open'); }
	    modalClose.addEventListener('click', closeModal);
	    modalBackdrop.addEventListener('click', closeModal);
	    window.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeModal(); });

	    elGrid.addEventListener('click', (e)=>{
	      const btn = e.target.closest('button[data-action="contact-job"]');
	      if(!btn) return;
	      const jobId = btn.getAttribute('data-job-id');
	      const jobTitle = btn.getAttribute('data-job-title');
	      if(!jobId){
	        alert('Sorry ‚Äî this job is missing an Airtable record ID, so we cannot send an enquiry.');
	        return;
	      }
	      openModal({ jobId, jobTitle });
	    });

	    modalForm.addEventListener('submit', async (e)=>{
	      e.preventDefault();
	      modalStatus.textContent = '';
	      modalStatus.className = '';
	      modalSubmit.disabled = true;
	
	      const payload = {
	        type: 'Contact Customer',
	        fromName: modalForm.fromName.value.trim(),
	        fromEmail: modalForm.fromEmail.value.trim(),
	        fromPhone: modalForm.fromPhone.value.trim(),
	        message: modalForm.message.value.trim(),
	        relatedJobId: modalJobId.value
	      };
	
	      try{
	        const res = await fetch(ENQUIRIES_WORKER_URL, {
	          method: 'POST',
	          headers: { 'Content-Type': 'application/json' },
	          body: JSON.stringify(payload)
	        });
	        if(!res.ok){
	          const txt = await res.text().catch(()=> '');
	          throw new Error(`Request failed (${res.status}) ${txt}`);
	        }
	        modalStatus.textContent = 'Thanks! Your message has been sent.';
	        modalStatus.className = 'success';
	        setTimeout(closeModal, 900);
	      }catch(err){
	        console.error(err);
	        modalStatus.textContent = 'Sorry, something went wrong sending your message. Please try again.';
	        modalStatus.className = 'error';
	      }finally{
	        modalSubmit.disabled = false;
	      }
	    });

    load();
  </script>
</body>
</html>
