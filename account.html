<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>My Account â€” Find Your Next Handyman</title>
  <style>
    body { font-family: system-ui, Arial; background:#f6f7fb; margin:0; }
    .wrap { max-width: 720px; margin: 40px auto; background:#fff; padding:24px; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.06); }
    h1 { margin:0 0 6px 0; }
    p { margin: 0 0 16px 0; color:#444; }
    label { display:block; margin:14px 0 6px; font-weight:600; }
    input { width:100%; padding:12px 14px; border:1px solid #ddd; border-radius:10px; }
    button { margin-top:12px; padding:12px 14px; border:0; border-radius:10px; background:#1f59ff; color:#fff; font-weight:700; cursor:pointer; }
    button.secondary { background:#eee; color:#111; }
    .row { display:flex; gap:12px; align-items:flex-end; }
    .row > div { flex:1; }
    .status { margin-top:14px; padding:12px; border-radius:10px; background:#f2f6ff; border:1px solid #d7e3ff; color:#143c9f; }
    .tokenBox { margin-top:10px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; word-break: break-all; background:#fafafa; border:1px solid #eee; padding:10px; border-radius:10px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>My Account</h1>
    <p>Sign in with email + one-time code (OTP).</p>

    <div class="row">
      <div>
        <label>Email</label>
        <input id="email" placeholder="you@example.com" />
      </div>
      <div style="max-width:220px;">
        <button id="sendBtn">Send code</button>
      </div>
    </div>

    <div class="row">
      <div>
        <label>OTP code</label>
        <input id="otp" placeholder="6-digit code" />
      </div>
      <div style="max-width:220px;">
        <button id="verifyBtn">Verify</button>
      </div>
    </div>

    <button class="secondary" id="logoutBtn" style="display:none;">Log out</button>

    <div class="status" id="status">Not signed in.</div>
    <div class="tokenBox" id="tokenBox" style="display:none;"></div>
  </div>

  <script>
    const WORKER_BASE = "https://handyman-auth-otp.l-aigbefoh.workers.dev";

    const els = {
      email: document.getElementById("email"),
      otp: document.getElementById("otp"),
      sendBtn: document.getElementById("sendBtn"),
      verifyBtn: document.getElementById("verifyBtn"),
      logoutBtn: document.getElementById("logoutBtn"),
      status: document.getElementById("status"),
      tokenBox: document.getElementById("tokenBox"),
    };

    function setStatus(msg) {
      els.status.textContent = msg;
    }

    function setLoggedIn(token) {
      localStorage.setItem("auth_token", token);
      els.logoutBtn.style.display = "inline-block";
      els.tokenBox.style.display = "block";
      els.tokenBox.textContent = "Token:\n" + token;
      setStatus("Signed in.");
    }

    function setLoggedOut() {
      localStorage.removeItem("auth_token");
      els.logoutBtn.style.display = "none";
      els.tokenBox.style.display = "none";
      els.tokenBox.textContent = "";
      setStatus("Not signed in.");
    }

    // On load, show token if exists
    const existing = localStorage.getItem("auth_token");
    if (existing) setLoggedIn(existing);

    els.sendBtn.addEventListener("click", async () => {
      const email = els.email.value.trim();
      if (!email) return setStatus("Enter an email first.");

      setStatus("Sending code...");
      try {
        const res = await fetch(WORKER_BASE + "/request-otp", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email }),
        });
        const data = await res.json();
        if (!res.ok || !data.ok) {
          return setStatus("Error sending code.");
        }
        setStatus("Code sent. Check your email, then enter it below.");
      } catch (e) {
        setStatus("Network error sending code.");
      }
    });

    els.verifyBtn.addEventListener("click", async () => {
      const email = els.email.value.trim();
      const otp = els.otp.value.trim();
      if (!email) return setStatus("Enter your email.");
      if (!otp) return setStatus("Enter the OTP code.");

      setStatus("Verifying...");
      try {
        const res = await fetch(WORKER_BASE + "/verify-otp", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, otp }),
        });
        const data = await res.json();
        if (!res.ok || !data.ok || !data.verified || !data.token) {
          return setStatus("Invalid OTP. Try again.");
        }
        setLoggedIn(data.token);
      } catch (e) {
        setStatus("Network error verifying code.");
      }
    });

    els.logoutBtn.addEventListener("click", () => {
      setLoggedOut();
    });
  </script>
</body>
</html>
