<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>My Account â€” Find Your Next Handyman</title>
  <style>
    body { font-family: system-ui, Arial; background:#f6f7fb; margin:0; }
    .wrap { max-width: 920px; margin: 40px auto; padding: 0 16px; }
    .card { background:#fff; padding:24px; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.06); margin-bottom: 16px; }
    h1 { margin:0 0 6px 0; }
    p { margin: 0 0 16px 0; color:#444; }
    label { display:block; margin:14px 0 6px; font-weight:600; }
    input, textarea { width:100%; padding:12px 14px; border:1px solid #ddd; border-radius:10px; font: inherit; }
    textarea { min-height: 110px; resize: vertical; }
    button { padding:12px 14px; border:0; border-radius:10px; background:#1f59ff; color:#fff; font-weight:700; cursor:pointer; }
    button.secondary { background:#eee; color:#111; }
    .row { display:flex; gap:12px; align-items:flex-end; flex-wrap: wrap; }
    .row > div { flex:1; min-width: 240px; }
    .status { margin-top:14px; padding:12px; border-radius:10px; background:#f2f6ff; border:1px solid #d7e3ff; color:#143c9f; }
    .monoBox { margin-top:10px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; word-break: break-all; background:#fafafa; border:1px solid #eee; padding:10px; border-radius:10px; }
    .hidden { display:none; }
    .actions { display:flex; gap:10px; flex-wrap: wrap; margin-top: 12px; }
    .muted { color:#666; font-size: 13px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>My Account</h1>
      <p>Sign in with email + one-time code (OTP).</p>

      <div class="row">
        <div>
          <label>Email</label>
          <input id="email" placeholder="you@example.com" autocomplete="email" />
        </div>
        <div style="max-width:220px;">
          <button id="sendBtn">Send code</button>
        </div>
      </div>

      <div class="row">
        <div>
          <label>OTP code</label>
          <input id="otp" placeholder="6-digit code" inputmode="numeric" />
        </div>
        <div style="max-width:220px;">
          <button id="verifyBtn">Verify</button>
        </div>
      </div>

      <div class="actions">
        <button class="secondary hidden" id="logoutBtn">Log out</button>
      </div>

      <div class="status" id="status">Not signed in.</div>
      <div class="monoBox hidden" id="tokenBox"></div>
    </div>

    <div class="card hidden" id="profileCard">
      <h2 style="margin:0 0 8px 0;">Your profile</h2>
      <div class="muted">This is stored in KV and linked to your email.</div>

      <div class="row">
        <div>
          <label>Name</label>
          <input id="name" placeholder="Your name" />
        </div>
        <div>
          <label>Phone</label>
          <input id="phone" placeholder="+44..." />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Location</label>
          <input id="location" placeholder="City / area" />
        </div>
        <div>
          <label>Services (comma separated)</label>
          <input id="services" placeholder="Plumbing, Painting, ..." />
        </div>
      </div>

      <label>Bio</label>
      <textarea id="bio" placeholder="Tell customers about your experience..."></textarea>

      <div class="actions">
        <button id="saveBtn">Save profile</button>
        <button class="secondary" id="refreshBtn">Refresh</button>
      </div>

      <div class="status" id="profileStatus">Profile not loaded yet.</div>
      <div class="monoBox hidden" id="profileJson"></div>
    </div>
  </div>

  <script>
    const WORKER_BASE = "https://handyman-auth-otp.l-aigbefoh.workers.dev";

    const els = {
      email: document.getElementById("email"),
      otp: document.getElementById("otp"),
      sendBtn: document.getElementById("sendBtn"),
      verifyBtn: document.getElementById("verifyBtn"),
      logoutBtn: document.getElementById("logoutBtn"),
      status: document.getElementById("status"),
      tokenBox: document.getElementById("tokenBox"),

      profileCard: document.getElementById("profileCard"),
      name: document.getElementById("name"),
      phone: document.getElementById("phone"),
      location: document.getElementById("location"),
      services: document.getElementById("services"),
      bio: document.getElementById("bio"),
      saveBtn: document.getElementById("saveBtn"),
      refreshBtn: document.getElementById("refreshBtn"),
      profileStatus: document.getElementById("profileStatus"),
      profileJson: document.getElementById("profileJson"),
    };

    function setStatus(msg) {
      els.status.textContent = msg;
    }

    function setProfileStatus(msg) {
      els.profileStatus.textContent = msg;
    }

    function getToken() {
      return localStorage.getItem("auth_token") || "";
    }

    function showLoggedIn(token) {
      localStorage.setItem("auth_token", token);
      els.logoutBtn.classList.remove("hidden");
      els.tokenBox.classList.remove("hidden");
      els.tokenBox.textContent = "Token:\n" + token;
      setStatus("Signed in.");
      els.profileCard.classList.remove("hidden");
    }

    function showLoggedOut() {
      localStorage.removeItem("auth_token");
      els.logoutBtn.classList.add("hidden");
      els.tokenBox.classList.add("hidden");
      els.tokenBox.textContent = "";
      setStatus("Not signed in.");
      els.profileCard.classList.add("hidden");
      setProfileStatus("Profile not loaded yet.");
      els.profileJson.classList.add("hidden");
      els.profileJson.textContent = "";
    }

    function fillProfileForm(profile) {
      els.name.value = profile.name || "";
      els.phone.value = profile.phone || "";
      els.location.value = profile.location || "";
      els.bio.value = profile.bio || "";
      const svcs = Array.isArray(profile.services) ? profile.services : [];
      els.services.value = svcs.join(", ");
    }

    function parseServices(input) {
      return input
        .split(",")
        .map(s => s.trim())
        .filter(Boolean);
    }

    async function loadProfile() {
      const token = getToken();
      if (!token) return;

      setProfileStatus("Loading profile...");
      try {
        const res = await fetch(WORKER_BASE + "/me", {
          method: "GET",
          headers: { "Authorization": "Bearer " + token }
        });

        const data = await res.json().catch(() => null);

        if (!res.ok || !data || !data.ok || !data.profile) {
          setProfileStatus("Could not load profile. Please sign in again.");
          return;
        }

        fillProfileForm(data.profile);
        setProfileStatus("Profile loaded.");
        els.profileJson.classList.remove("hidden");
        els.profileJson.textContent = JSON.stringify(data.profile, null, 2);
      } catch (e) {
        setProfileStatus("Network error loading profile.");
      }
    }

    async function saveProfile() {
      const token = getToken();
      if (!token) return;

      setProfileStatus("Saving profile...");
      try {
        const payload = {
          name: els.name.value.trim(),
          phone: els.phone.value.trim(),
          location: els.location.value.trim(),
          bio: els.bio.value.trim(),
          services: parseServices(els.services.value)
        };

        const res = await fetch(WORKER_BASE + "/me", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + token
          },
          body: JSON.stringify(payload)
        });

        const data = await res.json().catch(() => null);

        if (!res.ok || !data || !data.ok || !data.profile) {
          setProfileStatus("Save failed. Please sign in again.");
          return;
        }

        setProfileStatus("Saved.");
        els.profileJson.classList.remove("hidden");
        els.profileJson.textContent = JSON.stringify(data.profile, null, 2);
      } catch (e) {
        setProfileStatus("Network error saving profile.");
      }
    }

    els.sendBtn.addEventListener("click", async () => {
      const email = els.email.value.trim();
      if (!email) return setStatus("Enter an email first.");

      setStatus("Sending code...");
      try {
        const res = await fetch(WORKER_BASE + "/request-otp", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email }),
        });

        const data = await res.json().catch(() => null);

        if (!res.ok || !data || !data.ok) {
          return setStatus("Error sending code.");
        }

        setStatus("Code sent. Check your email, then enter it below.");
      } catch (e) {
        setStatus("Network error sending code.");
      }
    });

    els.verifyBtn.addEventListener("click", async () => {
      const email = els.email.value.trim();
      const otp = els.otp.value.trim();
      if (!email) return setStatus("Enter your email.");
      if (!otp) return setStatus("Enter the OTP code.");

      setStatus("Verifying...");
      try {
        const res = await fetch(WORKER_BASE + "/verify-otp", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, otp }),
        });

        const data = await res.json().catch(() => null);

        if (!res.ok || !data || !data.ok || !data.verified || !data.token) {
          return setStatus("Invalid OTP. Try again.");
        }

        showLoggedIn(data.token);
        await loadProfile();
      } catch (e) {
        setStatus("Network error verifying code.");
      }
    });

    els.logoutBtn.addEventListener("click", async () => {
      const token = getToken();
      if (!token) return showLoggedOut();

      try {
        await fetch(WORKER_BASE + "/logout", {
          method: "POST",
          headers: { "Authorization": "Bearer " + token }
        });
      } catch (e) {}

      showLoggedOut();
    });

    els.saveBtn.addEventListener("click", async () => {
      await saveProfile();
    });

    els.refreshBtn.addEventListener("click", async () => {
      await loadProfile();
    });

    const existing = getToken();
    if (existing) {
      showLoggedIn(existing);
      loadProfile();
    }
  </script>
</body>
</html>
